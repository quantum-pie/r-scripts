---
title: "Анализ продаж видеоигр на конкурирующих платформах"
author: "Павел Ермаков"
output: 
  html_document:
    toc: yes
    toc_float: yes
urlcolor: blue
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(forcats)
library(tidyr)

plot_theme <- theme_bw()+
              theme(plot.title = element_text(hjust = 0.5, size = 14), 
              axis.title.x = element_text(size = 12),
              axis.title.y = element_text(size = 12),
              axis.text.x = element_text(size = 10),
              axis.text.y = element_text(size = 10),
              legend.title = element_text(size = 12),
              legend.text = element_text(size = 10))

knitr::opts_chunk$set(echo = FALSE)
```

## Введение

Данные для исследования взяты из списка наиболее популярных в настоящее время массивов данных на платформе [Kaggle](https://www.kaggle.com)[^1].

[^1]: [Прямая ссылка](https://drive.google.com/file/d/0B_AraRsME-6teGFnOVpORVptZVU/view?usp=sharing) для скачивания данных 

```{r import}
data <- as_data_frame(read.csv("vgsales.csv"))
```

Массив данных содержит сведения о `r nrow(data)` видеоиграх, чьи мировые объемы продаж превысили 100 тысяч копий. 
Сведения собраны за период с `r min(strtoi(data$Year), na.rm=T)` г. по настоящее время и включают в себя следующие интересующие нас переменные:

* Номинативная переменная __Platform__ (игровая платформа) со следующими значениями:

```{r platforms}
levels(data$Platform)
```

* Непрерывная переменная __Global\_Sales__ (мировые продажи), выраженная в миллионах проданных копий.

Более подробно со структурой массива данных можно ознакомиться, взглянув на его первые несколько строчек:

```{r structure}
knitr::kable(head(data, 5), align = "l")
```

## Гипотеза

Мы заинтересованы в том, чтобы выяснить, существует ли значительный перевес в долях продаж видеоигр на двух наиболее популярных в настоящее время семействах приставок: __PlayStation__ и __XBox__, а также проследить изменение этого перевеса с течением времени. Для этого будем использовать __R__ версии `r getRversion()`.

Алгоритм работы:

1. Прочитать данные
2. Проанализировать общую динамику продаж:
    + Аггрегировать данные на интересующих приставках
    + Визуализировать
    + Проанализировать результаты
3. Проанализировать динамику соотношения продаж:
    + Вычислить процентное соотношение продаж по семействам приставок
    + Визуализировать
    + Проанализировать результаты
4. Проанализировать соотношение продаж в группах семейство-поколение:
    + Разбить платформы на два фактора: семейство и поколение, аггрегировать данные продаж
    + Визуализировать
    + Проанализировать результаты
5. Сделать общие выводы

## Анализ

### Общая динамика

Для начала посмотрим на динамику продаж по интересущим нас платформам в целом. Мы будем рассматривать все семейство __PlayStation__: __PS__, __PS2__, __PS3__ и __PS4__, а также все семейство __XBox__: __XBox__, __Xbox 360__, __XBox One__. Специфические модели (например, мобильные) не рассматриваются. Аггрегируя соответствующим образом данные, получим таблицу следующего вида:

```{r overall_analysis}
overall_data <- 
  data %>%
  # преобразование строкого представления года в числовое
  mutate(Year = strtoi(Year)) %>%
  # выбор интересующих переменных
  select(Year, Global_Sales, Platform) %>%
  # фильтрация интересующих платформ и удаление данных с неизвестным годом
  filter(Platform %in% c("PS", "PS2", "PS3", "PS4", "XB", "X360", "XOne"), !is.na(Year)) %>%
  group_by(Year, Platform) %>%
  # вычисление годового объема продаж игр по интересующим платформам
  summarize(Total_Sales = sum(Global_Sales)) 

knitr::kable(head(overall_data, 3), caption = "Общая динамика продаж", padding = 0, align = "l")
```

Визуализируем данные:

```{r plot_1, fig.height=5, fig.width=10}
ggplot(overall_data, aes(Year, Total_Sales))+
  ggtitle("Динамика годовых продаж видеоигр")+
  geom_col(aes(fill = Platform))+
  scale_x_continuous(breaks = seq(1990, 2017, 2), name = "Год")+
  scale_y_continuous(breaks = seq(0, 350, 50), name = "Годовые продажи, миллионов копий")+
  scale_fill_discrete(name = "Платформа")+
  plot_theme
```

По приведенному графику можно заметить, что первая приставка линейки __PlayStation__ не имела конкурента из линейки __XBox__. С выходом __PS2__ в 2000-м году появляется первая __XBox__, но до следующего поколения приставок перевес продаж сохраняется в пользу __PlayStation__. С выходом следующего поколения (__PS3__, __XBox 360__) отличие в продажах кажется уже не таким существенным, но при появлении __PS4__ и __XBox One__ в 2013-м году по продажам снова начинает преобладать __PlayStation__.

### Динамика соотношения продаж

Проанализируем более строго динамику изменения соотношения продаж по семействам приставок. Для этого аггрегируем все продажи в пределах одного семейства в одну переменную и вычислим процентное соотношение в продажах между семействами относительно суммарного числа продаж. Получим таблицу следующего вида:

```{r percent_analysis}
timeline_data <- 
  # таблица с предыдущего шага
  overall_data %>%
  # сведение приставок из одного семейства в единственное значение фактора
  mutate(Platform = fct_collapse(Platform, 
                                 PS = c("PS", "PS2", "PS3", "PS4"), 
                                 XBOX = c("XB", "X360", "XOne"))
                                 ) %>%
  group_by(Year, Platform) %>%
  # аггрегирование продаж
  summarise(Total_Sales = sum(Total_Sales)) %>%
  # вычисление процентного соотношения (предыдущий вызов summarise снимает группировку по Platform)
  mutate(Portion = 100 * Total_Sales / sum(Total_Sales)) %>%
  # фильтрация данных только по PlayStation (процент XBox при желании можно однозначно определить)
  # фильтрация только тех лет, когда на рынке присутствовали приставки обоих семейств одновременно
  filter(Platform == "PS" & Total_Sales != sum(Total_Sales)) 

knitr::kable(head(timeline_data, 3), caption = "Динамика соотношения продаж", padding = 0, align = "l")
```

Визуализируем данные:

```{r plot2, fig.height=5, fig.width=10}
ggplot(timeline_data, aes(Year, Portion))+
  geom_smooth(method = "loess", se = F, color = "#ffa700", size = 1.4)+
  geom_point(color = "#0057e7", size = 2)+
  scale_x_continuous(breaks = seq(2000, 2017, 2), name = "Год")+
  scale_y_continuous(breaks = seq(40, 100, 10), name = "Доля PS на рынке, %")+
  ggtitle("Динамика соотношения продаж между PS и XBox")+
  plot_theme
```

Данный график можно условно поделить на две части: 

* Период с 2000-го по 2011-й год, когда с начала своего появления приставка __XBox__ плавно перетягивала на себя долю рынка __PlayStation__, первоначально им монополизированную (в смысле противостояния __PS__ - __XBox__)

* Период с 2012-го года по настоящее время, когда были анонсированы и впоследствии выпущены приставки последнего на данный момент поколения. В этом периоде __PlayStation__ начинает восстанавливать позиции на рынке. Видимо, это можно объяснить тем, что последняя приставка __PlayStation__ вышла крайне удачной по сравнению с конкурентом

### Соотношение продаж в группах семейство-поколение

Здесь мы более тщательно рассмотрим три поколения, для которых доступны данные: это __PS2__, __PS3__ и __PS4__ из семейства __PlayStation__ и соответственно __XBox__, __XBox 360__ и __XBox One__ из семейства __XBox__. Для данного анализа введем переменную __Generation__, которая отвечает за условно первое (__PS2__, __XBox__), второе (__PS3__, __XBox 360__) и третье (__PS4__, __XBox One__) поколения приставок, а затем аггрегируем данные по продажам на пересечении семейств и поколений. Получим следующую таблицу сопряженности:

```{r family_gen}
console_gen_contingency <- 
  # данные с первого шага
  overall_data %>%
  # снять группировку
  ungroup() %>%
  # фильтрация только тех лет, когда на рынке присутствовали приставки обоих семейств одновременно
  filter(Platform != "PS") %>%
  select(Total_Sales, Platform) %>%
  # создание переменной, отвечающей за поколение
  mutate(Generation = droplevels(
                        fct_collapse(Platform, 
                                     First = c("PS2", "XB"), 
                                     Second = c("PS3", "X360"), 
                                     Third = c("PS4", "XOne"))
                                )) %>%
  # сведение приставок из одного семейства в единственное значение фактора
  mutate(Platform = droplevels(
                      fct_collapse(Platform, 
                                   PS = c("PS2", "PS3", "PS4"), 
                                   XBOX = c("XB", "X360", "XOne"))
                              )) %>%
  group_by(Platform, Generation) %>%
  # аггрегирование данных
  summarise(Total_Sales = sum(Total_Sales)) 

# перевод уровней для графика
levels(console_gen_contingency$Generation) <- c("Первое", "Второе", "Третье")

# создание таблицы сопряженности
console_gen_table <- xtabs(Total_Sales ~ Generation + Platform, console_gen_contingency)

knitr::kable(console_gen_table, caption = "Распределение продаж по группам семейство-поколение", padding = 0, align = "l")
```

Визуализируем данные:

```{r plot3}
mosaicplot(console_gen_table, 
           color = c("#c95719", "#128a94"), 
           main = NA, xlab = "Поколение", ylab = "Семейство")
```

По данному графику хорошо видны тенденции изменения продаж при переходе от одного поколения к другому, а также между семействами приставок. В частности, как было сказано ранее, здесь отчетливо видно, что с выходом __XBox__ второго поколения соотношение продаж почти сравнялось, но в третьем поколении пока преобладает __PlayStation__, хотя его жизненный цикл еще не окончен. В целом, по графику можно сделать вывод о том, что изначальная гипотеза подтвердилась, и соотношение между продажами в конкурирующих семействах приставок неравномерно и меняется с течением времени.

## Выводы

По результатам исследования можно сделать выводы о том, что соотношение сил на рынке конкурирующих приставок __PlayStation__ и __XBox__ неравномерно и меняется со временем, претерпевая переломные моменты при смене поколений.